---
interface Props {
  chart: string;
  class?: string;
  width?: string;
}

const { chart, class: className = '', width = '100%' } = Astro.props;
---

<div class:list={["mermaid-container", className]}>
  <div class="mermaid" style={`width: ${width};`}>
    {chart}
  </div>
</div>

<script>
  import mermaid from 'mermaid';

  // Function to initialize mermaid with appropriate theme settings
  function initMermaid() {
    const isDark = document.documentElement.classList.contains('dark');
    
    mermaid.initialize({
      startOnLoad: true,
      theme: isDark ? 'dark' : 'default',
      themeVariables: {
        darkMode: isDark,
        // Base colors
        primaryColor: isDark ? '#1e88e5' : '#1e88e5',
        primaryTextColor: isDark ? '#fff' : '#000',
        primaryBorderColor: isDark ? '#1e88e5' : '#1e88e5',
        
        // Pie chart specific colors for dark mode
        pieSectionTextColor: isDark ? '#fff' : '#000',
        pieTitleTextColor: isDark ? '#fff' : '#000',
        pieSectionTextSize: '0.875rem',
        pieTitleTextSize: '0.875rem',
        
        // Background colors
        backgroundColor: isDark ? 'transparent' : '#f8f9fa',
        
        // General text and line colors
        lineColor: isDark ? '#d3d3d3' : '#666',
        textColor: isDark ? '#fff' : '#333',
        
        // Make labels more visible in dark mode
        labelColor: isDark ? '#ffffff' : '#333333',
        labelTextColor: isDark ? '#ffffff' : '#333333',
        
        // Node colors
        nodeBorder: isDark ? '#aaa' : '#333',
        nodeTextColor: isDark ? '#fff' : '#333',
        
        // Font sizes for better readability
        fontSize: 12,
        ganttFontSize: 12,
        ganttLeftPadding: 75,
        
        // Node padding to prevent text clipping
        nodePadding: 12,
        mainBkg: isDark ? '#2d2d2d' : '#f8f9fa',
        defaultLinkColor: isDark ? '#d3d3d3' : '#666',
      },
      htmlLabels: true,
      securityLevel: 'loose',
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        nodeSpacing: 60,
        rankSpacing: 60,
        padding: 20,
        curve: 'basis'
      },
      gantt: {
        useMaxWidth: true,
        fontSize: 12
      },
      sequence: {
        useMaxWidth: true
      },
      timeline: {
        useMaxWidth: true
      },
      pie: {
        useMaxWidth: true
      }
    });
    
    // Re-render all diagrams
    const initResult = mermaid.init(undefined, document.querySelectorAll('.mermaid'));
    
    // Adjust viewBox after rendering (handle both promise and non-promise returns)
    const adjustViewBox = () => {
      // Use setTimeout to ensure rendering is complete
      setTimeout(() => {
        document.querySelectorAll('.mermaid svg').forEach(svg => {
          const viewBox = svg.getAttribute('viewBox');
          if (viewBox) {
            const parts = viewBox.split(' ').map(Number);
            if (parts.length === 4) {
              const [x, y, width, height] = parts;
              // Add minimal padding around the viewBox (5% on each side) to prevent text clipping without making chart tiny
              const padding = Math.max(width, height) * 0.05;
              svg.setAttribute('viewBox', 
                `${x - padding} ${y - padding} ${width + padding * 2} ${height + padding * 2}`
              );
            }
          }
        });
      }, 100);
    };
    
    if (initResult && typeof initResult.then === 'function') {
      initResult.then(adjustViewBox);
    } else {
      adjustViewBox();
    }
  }

  // Initialize on load
  initMermaid();

  // Re-render diagrams when dark mode changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        initMermaid();
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class'],
  });
</script>

<style>
  /* Container to handle centering and spacing */
  .mermaid-container {
    display: flex;
    justify-content: center;
    width: 100%;
    padding: 1.5rem 0;
    margin: 1rem 0;
    overflow-x: auto;
  }
  
  /* Chart styles */
  .mermaid {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    min-width: 400px;
  }
  
  /* Adding some global styles for mermaid in dark mode */
  :global(.dark .mermaid text) {
    fill: #ffffff !important;
  }
  
  :global(.dark .mermaid .pieOuterCircle) {
    stroke: #555 !important;
  }
  
  :global(.dark .mermaid .pieTitleText) {
    fill: #ffffff !important;
  }
  
  /* Ensure chart has enough space for title */
  :global(.mermaid svg) {
    padding: 1rem;
    margin: 0 auto;
    min-width: 400px;
    width: 100% !important;
    height: auto !important;
    overflow: visible !important;
  }
  
  /* Prevent text clipping in nodes */
  :global(.mermaid .node rect),
  :global(.mermaid .node polygon),
  :global(.mermaid .node circle) {
    overflow: visible !important;
  }
  
  /* Ensure text labels have enough space */
  :global(.mermaid .nodeLabel),
  :global(.mermaid .label),
  :global(.mermaid .edgeLabel) {
    overflow: visible !important;
    white-space: normal !important;
    word-wrap: break-word !important;
  }
  
  /* Add padding to node text */
  :global(.mermaid .node text) {
    overflow: visible !important;
    dominant-baseline: middle;
    text-anchor: middle;
  }
  
  /* General text sizing for all mermaid elements */
  :global(.mermaid text) {
    font-size: 12px !important;
  }
  
  /* Pie chart titles - slightly larger but still readable */
  :global(.mermaid .pieTitleText) {
    dominant-baseline: hanging;
    text-anchor: middle;
    font-size: 0.875rem !important;
    font-weight: bold;
  }
  
  /* Timeline specific fixes */
  :global(.mermaid .timeline text) {
    font-size: 12px !important;
  }
  
  :global(.mermaid .section) {
    font-size: 12px !important;
  }
  
  /* Node text sizing */
  :global(.mermaid .nodeLabel) {
    font-size: 12px !important;
  }
  
  /* Make sure the mermaid diagram doesn't get too small on mobile */
  @media (max-width: 768px) {
    .mermaid-container {
      overflow-x: auto;
      justify-content: flex-start;
    }
    
    .mermaid {
      min-width: 100%;
    }
  }
</style> 