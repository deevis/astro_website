---
import Layout from '../../layouts/Layout.astro';

const pageTitle = 'QR Code Generator/Scanner';
const pageDescription = 'Generate QR codes from text and scan QR codes using images or your webcam';
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="qr-wrapper">
    <div class="container mx-auto px-4">
      <main class="qr-container">
        <h1 class="page-title">QR Code Generator/Scanner</h1>
        
        <div class="tabs">
          <button id="generate-tab" class="tab-btn active">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 4v16m8-8H4"/>
            </svg>
            Generate QR Code
          </button>
          <button id="scan-tab" class="tab-btn">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            Scan QR Code
          </button>
        </div>
        
        <!-- Generate Section -->
        <div id="generate-section" class="tab-content active">
          <div class="input-section">
            <label for="qr-input" class="input-label">
              <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Enter Text or URL
            </label>
            <textarea
              id="qr-input"
              class="qr-textarea"
              placeholder="Enter text, URL, or any data to encode..."
              rows="6"
              maxlength="2000"
            >https://darrenhicks.dev</textarea>
            <div class="input-info">
              <span id="input-length" class="char-count">0 / 2,000 characters</span>
              <span id="limit-warning" class="limit-warning hidden">⚠️ Approaching limit - larger QR codes may be harder to scan</span>
            </div>
          </div>
          
          <div class="controls">
            <button id="generate-btn" class="btn btn-primary">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Generate QR Code
            </button>
            <button id="download-btn" class="btn btn-secondary" disabled>
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Download QR Code
            </button>
          </div>
          
          <div class="qr-output">
            <div id="qr-canvas-container" class="qr-canvas-container">
              <canvas id="qr-canvas"></canvas>
              <div id="qr-placeholder" class="qr-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                <p>Your QR code will appear here</p>
              </div>
            </div>
            <div id="error-correction-info" class="error-correction-info hidden">
              <div class="ec-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0121 12a11.955 11.955 0 01-1.382 4.984M15 10l-3 3m0 0l-3-3m3 3V3"/>
                </svg>
                <div>
                  <div class="ec-label">Error Correction</div>
                  <div id="ec-level" class="ec-level">Medium (M)</div>
                  <div id="ec-description" class="ec-description">15% recovery - up to 370 chars</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scan Section -->
        <div id="scan-section" class="tab-content">
          <div class="scan-methods">
            <div class="scan-method">
              <h3 class="method-title">
                <svg class="method-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Upload Image
              </h3>
              <input type="file" id="file-input" accept="image/*" class="file-input" />
              <label for="file-input" class="file-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                Choose Image File
              </label>
            </div>
            
            <div class="scan-method">
              <h3 class="method-title">
                <svg class="method-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Use Webcam
              </h3>
              <button id="webcam-btn" class="btn btn-webcam">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                <span id="webcam-btn-text">Start Webcam</span>
              </button>
            </div>
          </div>
          
          <div id="scan-output" class="scan-output">
            <video id="webcam-video" class="webcam-video" autoplay playsinline></video>
            <canvas id="scan-canvas" class="scan-canvas"></canvas>
            <div id="scan-result" class="scan-result hidden">
              <div class="result-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h3>QR Code Detected!</h3>
              </div>
              <div id="scan-result-text" class="result-text"></div>
              <div class="result-actions">
                <button id="copy-result-btn" class="btn btn-small">
                  <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                  </svg>
                  Copy to Clipboard
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="info-section">
          <div class="info-header">
            <div class="info-header-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
              </svg>
            </div>
            <div>
              <h2 class="info-title">About QR Codes</h2>
              <p class="info-tagline">Two-dimensional barcodes for quick data access since 1994</p>
            </div>
          </div>
          
          <div class="info-grid">
            <div class="info-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
              </div>
              <h3 class="card-title">What is it?</h3>
              <p class="card-content">
                QR Code (Quick Response Code) is a two-dimensional barcode that can store various types of data including text, URLs, contact information, and more. It can be read quickly by cameras and smartphones, making it ideal for rapid information access.
              </p>
            </div>
            
            <div class="info-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
              </div>
              <h3 class="card-title">How It Works</h3>
              <p class="card-content">
                QR codes use patterns of black squares on a white background to encode data. They include three large squares in corners for positioning and timing patterns to help scanners read them. The patterns enable automatic rotation detection and error correction, allowing QR codes to work even when partially damaged or obscured.
              </p>
            </div>
            
            <div class="info-card highlight-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0121 12a11.955 11.955 0 01-1.382 4.984M15 10l-3 3m0 0l-3-3m3 3V3"/>
                </svg>
              </div>
              <h3 class="card-title">Smart Error Correction</h3>
              <p class="card-content" style="margin-bottom: 16px;">
                This tool automatically selects the optimal error correction level based on your data length, balancing reliability with capacity:
              </p>
              <div class="ec-levels-table">
                <div class="ec-level-row">
                  <div class="ec-level-name">
                    <strong>High (H)</strong>
                    <span class="ec-range">0-190 chars</span>
                  </div>
                  <div class="ec-level-desc">
                    30% recovery • Best for URLs and critical short data • Maximum protection against damage
                  </div>
                </div>
                <div class="ec-level-row">
                  <div class="ec-level-name">
                    <strong>Medium (M)</strong>
                    <span class="ec-range">191-370 chars</span>
                  </div>
                  <div class="ec-level-desc">
                    15% recovery • Balanced protection and capacity • Recommended for most use cases
                  </div>
                </div>
                <div class="ec-level-row">
                  <div class="ec-level-name">
                    <strong>Low (L)</strong>
                    <span class="ec-range">371-2,000 chars</span>
                  </div>
                  <div class="ec-level-desc">
                    7% recovery • Maximizes data capacity • Best for longer text in controlled environments
                  </div>
                </div>
              </div>
            </div>
            
            <div class="info-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <h3 class="card-title">Common Uses</h3>
              <ul class="card-list">
                <li><strong>Marketing & Advertising:</strong> Quick access to websites and promotional content</li>
                <li><strong>Payments:</strong> Mobile payment systems and cryptocurrency transactions</li>
                <li><strong>Authentication:</strong> Two-factor authentication and secure logins</li>
                <li><strong>Ticketing:</strong> Event tickets, boarding passes, and access control</li>
                <li><strong>Product Information:</strong> Tracking, inventory, and product details</li>
              </ul>
            </div>
            
            <div class="info-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <h3 class="card-title">History</h3>
              <p class="card-content">
                QR codes were invented in <strong>1994 by Masahiro Hara</strong> at Denso Wave, a Toyota subsidiary in Japan. Originally designed to track automotive parts during manufacturing, they became publicly available and gained worldwide popularity with the rise of smartphones in the 2000s.
              </p>
            </div>
          </div>
          
          <div class="info-note">
            <div class="note-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div>
              <h4 class="note-title">Privacy Tip</h4>
              <p class="note-content">
                Always verify QR codes before scanning, especially from unknown sources. Malicious QR codes can redirect to phishing sites or trigger unwanted downloads. Most modern smartphones show a preview of the URL before opening it.
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Load QR code libraries from CDN with fallback -->
  <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" 
    onload="console.log('✓ QRCode library loaded from cdnjs')"
    onerror="console.error('✗ Failed to load QRCode from cdnjs, trying fallback...'); 
             var script = document.createElement('script'); 
             script.src = 'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js';
             script.onload = function() { console.log('✓ QRCode library loaded from unpkg fallback'); };
             script.onerror = function() { console.error('✗ All QRCode library sources failed'); };
             document.head.appendChild(script);">
  </script>
  <script is:inline src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"
    onload="console.log('✓ jsQR library loaded')"
    onerror="console.error('✗ jsQR library failed to load')">
  </script>

  <script is:inline>
    // Debug library loading status
    setTimeout(function() {
      console.log('=== Library Loading Status ===');
      console.log('QRCode available:', typeof QRCode !== 'undefined');
      console.log('jsQR available:', typeof jsQR !== 'undefined');
      if (typeof QRCode !== 'undefined') {
        console.log('QRCode.CorrectLevel:', QRCode.CorrectLevel);
      }
    }, 500);
  </script>

  <script>
    // Wait for libraries to load
    function waitForLibraries() {
      return new Promise<void>((resolve) => {
        if (typeof (window as any).QRCode !== 'undefined') {
          console.log('QRCode library ready');
          resolve();
        } else {
          console.log('Waiting for QRCode library...');
          const checkInterval = setInterval(() => {
            if (typeof (window as any).QRCode !== 'undefined') {
              console.log('QRCode library loaded');
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
          
          // Timeout after 5 seconds
          setTimeout(() => {
            clearInterval(checkInterval);
            console.error('QRCode library load timeout');
            resolve(); // Resolve anyway to not block initialization
          }, 5000);
        }
      });
    }

    // Get DOM elements
    const generateTab = document.getElementById('generate-tab');
    const scanTab = document.getElementById('scan-tab');
    const generateSection = document.getElementById('generate-section');
    const scanSection = document.getElementById('scan-section');
    const qrInput = document.getElementById('qr-input') as HTMLTextAreaElement;
    const generateBtn = document.getElementById('generate-btn');
    const downloadBtn = document.getElementById('download-btn');
    const qrCanvas = document.getElementById('qr-canvas') as HTMLCanvasElement;
    const qrCanvasContainer = document.getElementById('qr-canvas-container');
    const qrPlaceholder = document.getElementById('qr-placeholder');
    const inputLength = document.getElementById('input-length');
    const limitWarning = document.getElementById('limit-warning');
    const errorCorrectionInfo = document.getElementById('error-correction-info');
    const ecLevel = document.getElementById('ec-level');
    const ecDescription = document.getElementById('ec-description');
    const fileInput = document.getElementById('file-input') as HTMLInputElement;
    const webcamBtn = document.getElementById('webcam-btn');
    const webcamBtnText = document.getElementById('webcam-btn-text');
    const webcamVideo = document.getElementById('webcam-video') as HTMLVideoElement;
    const scanCanvas = document.getElementById('scan-canvas') as HTMLCanvasElement;
    const scanResult = document.getElementById('scan-result');
    const scanResultText = document.getElementById('scan-result-text');
    const copyResultBtn = document.getElementById('copy-result-btn');

    let webcamStream: MediaStream | null = null;
    let scanningInterval: number | null = null;
    let librariesReady = false;

    // Initialize after libraries load
    waitForLibraries().then(() => {
      librariesReady = typeof (window as any).QRCode !== 'undefined';
      if (librariesReady) {
        console.log('All libraries ready, QR code generation enabled');
      } else {
        console.error('Failed to load QR code library - generation will not work');
      }
    });

    // Tab switching
    generateTab?.addEventListener('click', () => {
      generateTab.classList.add('active');
      scanTab?.classList.remove('active');
      generateSection?.classList.add('active');
      scanSection?.classList.remove('active');
      stopWebcam();
    });

    scanTab?.addEventListener('click', () => {
      scanTab.classList.add('active');
      generateTab?.classList.remove('active');
      scanSection?.classList.add('active');
      generateSection?.classList.remove('active');
    });

    // Update character count
    function updateCharCount() {
      const length = qrInput.value.length;
      const maxLength = 2000;
      
      if (inputLength) {
        inputLength.textContent = `${length.toLocaleString()} / ${maxLength.toLocaleString()} characters`;
        
        // Update color based on usage
        if (length > maxLength * 0.9) {
          inputLength.style.color = '#dc3545';
          inputLength.style.fontWeight = '600';
        } else if (length > maxLength * 0.75) {
          inputLength.style.color = '#ffc107';
          inputLength.style.fontWeight = '600';
        } else {
          inputLength.style.color = '';
          inputLength.style.fontWeight = '';
        }
      }
      
      // Show warning when approaching limit
      if (limitWarning) {
        if (length > maxLength * 0.75) {
          limitWarning.classList.remove('hidden');
        } else {
          limitWarning.classList.add('hidden');
        }
      }
    }

    qrInput?.addEventListener('input', updateCharCount);

    // Generate QR Code using pure canvas implementation
    function generateQRCode(text: string) {
      // Check if library is loaded
      if (typeof (window as any).QRCode === 'undefined') {
        showNotification('QR Code library failed to load. Please refresh the page.', 'error');
        console.error('QRCode library not found on window object. Available window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('qr')));
        return;
      }

      try {
        // Clear any existing QR code
        const existingQR = qrCanvasContainer?.querySelector('.qrcode-container');
        if (existingQR) {
          existingQR.remove();
        }

        // Hide canvas, show container
        qrCanvas.style.display = 'none';
        
        // Create container for QR code
        const qrContainer = document.createElement('div');
        qrContainer.className = 'qrcode-container';
        qrContainer.style.display = 'flex';
        qrContainer.style.justifyContent = 'center';
        qrContainer.style.alignItems = 'center';
        
        // Determine optimal error correction based on text length
        // H (30% correction) = max ~190 chars, M (15%) = ~370 chars, L (7%) = ~2000 chars
        let correctLevel = (window as any).QRCode.CorrectLevel.M; // Medium is good default
        let levelName = 'Medium (M)';
        let levelDescription = '15% recovery - up to 370 chars';
        
        if (text.length <= 190) {
          correctLevel = (window as any).QRCode.CorrectLevel.H; // High for short text
          levelName = 'High (H)';
          levelDescription = '30% recovery - maximum protection';
        } else if (text.length > 370) {
          correctLevel = (window as any).QRCode.CorrectLevel.L; // Low for long text
          levelName = 'Low (L)';
          levelDescription = '7% recovery - up to 2,000 chars';
        }
        
        // Update error correction display
        if (ecLevel) ecLevel.textContent = levelName;
        if (ecDescription) ecDescription.textContent = levelDescription;
        if (errorCorrectionInfo) errorCorrectionInfo.classList.remove('hidden');
        
        // Generate QR code
        const qrcode = new (window as any).QRCode(qrContainer, {
          text: text,
          width: 256,
          height: 256,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: correctLevel
        });

        // Insert into container
        qrCanvasContainer?.appendChild(qrContainer);

        // Wait for image to be generated, then copy to canvas for download
        setTimeout(() => {
          const img = qrContainer.querySelector('img') as HTMLImageElement;
          if (img) {
            img.onload = () => {
              qrCanvas.width = 256;
              qrCanvas.height = 256;
              const ctx = qrCanvas.getContext('2d');
              if (ctx) {
                ctx.drawImage(img, 0, 0);
              }
            };
            // If already loaded
            if (img.complete) {
              qrCanvas.width = 256;
              qrCanvas.height = 256;
              const ctx = qrCanvas.getContext('2d');
              if (ctx) {
                ctx.drawImage(img, 0, 0);
              }
            }
          }
        }, 100);

        qrPlaceholder?.classList.add('hidden');
        if (downloadBtn) downloadBtn.disabled = false;
        showNotification('QR code generated successfully!', 'success');
      } catch (error) {
        console.error('QR code generation error:', error);
        showNotification('Error generating QR code: ' + (error as Error).message, 'error');
      }
    }

    // Generate QR Code button handler
    generateBtn?.addEventListener('click', () => {
      const text = qrInput.value.trim();
      if (!text) {
        showNotification('Please enter some text to generate QR code', 'warning');
        return;
      }

      generateQRCode(text);
    });

    // Download QR Code
    downloadBtn?.addEventListener('click', () => {
      const url = qrCanvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = 'qrcode.png';
      a.click();
      showNotification('QR code downloaded!', 'success');
    });

    // File upload for scanning
    fileInput?.addEventListener('change', async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      const img = new Image();
      const reader = new FileReader();

      reader.onload = (event) => {
        img.onload = () => {
          scanCanvas.width = img.width;
          scanCanvas.height = img.height;
          const ctx = scanCanvas.getContext('2d');
          if (!ctx) return;

          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, img.width, img.height);
          const code = (window as any).jsQR(imageData.data, img.width, img.height);

          if (code) {
            displayScanResult(code.data);
          } else {
            showNotification('No QR code found in image', 'warning');
          }
        };
        img.src = event.target?.result as string;
      };

      reader.readAsDataURL(file);
    });

    // Webcam scanning
    webcamBtn?.addEventListener('click', async () => {
      if (webcamStream) {
        stopWebcam();
      } else {
        startWebcam();
      }
    });

    async function startWebcam() {
      try {
        webcamStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        webcamVideo.srcObject = webcamStream;
        webcamVideo.classList.add('active');
        if (webcamBtnText) webcamBtnText.textContent = 'Stop Webcam';
        webcamBtn?.classList.add('active');

        // Start scanning
        scanningInterval = window.setInterval(scanWebcamFrame, 100);
        showNotification('Webcam started - point at QR code', 'info');
      } catch (error) {
        showNotification('Could not access webcam. Please check permissions.', 'error');
      }
    }

    function stopWebcam() {
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
        webcamVideo.srcObject = null;
        webcamVideo.classList.remove('active');
        if (webcamBtnText) webcamBtnText.textContent = 'Start Webcam';
        webcamBtn?.classList.remove('active');
      }

      if (scanningInterval) {
        clearInterval(scanningInterval);
        scanningInterval = null;
      }
    }

    function scanWebcamFrame() {
      if (!webcamVideo.videoWidth) return;

      scanCanvas.width = webcamVideo.videoWidth;
      scanCanvas.height = webcamVideo.videoHeight;
      const ctx = scanCanvas.getContext('2d');
      if (!ctx) return;

      ctx.drawImage(webcamVideo, 0, 0);
      const imageData = ctx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
      const code = (window as any).jsQR(imageData.data, scanCanvas.width, scanCanvas.height);

      if (code) {
        displayScanResult(code.data);
        stopWebcam();
      }
    }

    function displayScanResult(text: string) {
      if (scanResultText) scanResultText.textContent = text;
      scanResult?.classList.remove('hidden');
      showNotification('QR code scanned successfully!', 'success');
    }

    // Copy result to clipboard
    copyResultBtn?.addEventListener('click', () => {
      const text = scanResultText?.textContent || '';
      navigator.clipboard.writeText(text).then(() => {
        showNotification('Copied to clipboard!', 'success');
      });
    });

    // Notification system
    function showNotification(message: string, type: 'success' | 'error' | 'warning' | 'info') {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();

      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => notification.classList.add('show'), 10);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Initialize
    updateCharCount();
  </script>

  <style is:global>
    .qr-wrapper {
      padding-top: 8rem;
      padding-bottom: 4rem;
      background: #f8f9fa;
      min-height: 100vh;
    }

    .dark .qr-wrapper {
      background: rgb(3, 7, 18);
    }

    .qr-container {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .dark .qr-container {
      background: rgb(17, 24, 39);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .page-title {
      font-size: 36px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .dark .page-title {
      background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      text-align: center;
      font-size: 16px;
      color: #7f8c8d;
      margin-bottom: 32px;
    }

    .dark .page-subtitle {
      color: rgb(156, 163, 175);
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      border-bottom: 2px solid #e1e8ed;
    }

    .dark .tabs {
      border-bottom-color: rgb(55, 65, 81);
    }

    .tab-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      background: none;
      font-size: 16px;
      font-weight: 600;
      color: #6c757d;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: #4facfe;
    }

    .tab-btn.active {
      color: #4facfe;
      border-bottom-color: #4facfe;
    }

    .dark .tab-btn.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    .tab-icon {
      width: 20px;
      height: 20px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .input-section {
      margin-bottom: 24px;
    }

    .input-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 12px;
    }

    .dark .input-label {
      color: rgb(243, 244, 246);
    }

    .label-icon {
      width: 20px;
      height: 20px;
      color: #4facfe;
    }

    .dark .label-icon {
      color: #3b82f6;
    }

    .qr-textarea {
      width: 100%;
      padding: 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      background: #f8f9fa;
      color: #2c3e50;
      transition: border-color 0.2s;
    }

    .dark .qr-textarea {
      background: rgb(31, 41, 55);
      border-color: rgb(55, 65, 81);
      color: rgb(229, 231, 235);
    }

    .qr-textarea:focus {
      outline: none;
      border-color: #4facfe;
    }

    .dark .qr-textarea:focus {
      border-color: #3b82f6;
    }

    .input-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .char-count {
      font-size: 13px;
      color: #6c757d;
      font-weight: 500;
      transition: color 0.2s;
    }

    .dark .char-count {
      color: rgb(156, 163, 175);
    }

    .limit-warning {
      font-size: 12px;
      color: #ffc107;
      background: rgba(255, 193, 7, 0.1);
      padding: 4px 12px;
      border-radius: 4px;
      border: 1px solid rgba(255, 193, 7, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    .dark .limit-warning {
      background: rgba(251, 191, 36, 0.15);
      border-color: rgba(251, 191, 36, 0.3);
      color: rgb(251, 191, 36);
    }

    .limit-warning.hidden {
      display: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-icon {
      width: 20px;
      height: 20px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #3f9bed 0%, #00d9ed 100%);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #32d86a 0%, #27e8c6 100%);
    }

    .btn-webcam {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }

    .btn-webcam:hover {
      background: linear-gradient(135deg, #e9608a 0%, #edcf30 100%);
    }

    .btn-webcam.active {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
    }

    .qr-output {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 48px;
    }

    .qr-canvas-container {
      position: relative;
      width: 256px;
      height: 256px;
    }

    .qrcode-container {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .qrcode-container img,
    .qrcode-container canvas {
      display: block !important;
      border-radius: 8px;
    }

    #qr-canvas {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
    }

    #qr-canvas.visible {
      display: block;
    }

    .qr-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      color: #a0aec0;
    }

    .qr-placeholder.hidden {
      display: none;
    }

    .error-correction-info {
      width: 100%;
      max-width: 400px;
      transition: all 0.3s ease;
    }

    .error-correction-info.hidden {
      display: none;
    }

    .ec-badge {
      display: flex;
      align-items: center;
      gap: 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #4facfe;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);
    }

    .dark .ec-badge {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
      border-color: #3b82f6;
    }

    .ec-badge svg {
      width: 32px;
      height: 32px;
      color: #4facfe;
      flex-shrink: 0;
    }

    .dark .ec-badge svg {
      color: #3b82f6;
    }

    .ec-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .dark .ec-label {
      color: rgb(156, 163, 175);
    }

    .ec-level {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 2px;
    }

    .dark .ec-level {
      color: rgb(243, 244, 246);
    }

    .ec-description {
      font-size: 13px;
      color: #6c757d;
    }

    .dark .ec-description {
      color: rgb(156, 163, 175);
    }

    .ec-levels-table {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ec-level-row {
      background: rgba(79, 172, 254, 0.05);
      border-left: 3px solid #4facfe;
      border-radius: 6px;
      padding: 12px 16px;
    }

    .dark .ec-level-row {
      background: rgba(59, 130, 246, 0.08);
      border-left-color: #3b82f6;
    }

    .ec-level-name {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .ec-level-name strong {
      color: #2c3e50;
      font-size: 15px;
    }

    .dark .ec-level-name strong {
      color: rgb(243, 244, 246);
    }

    .ec-range {
      font-size: 12px;
      color: #4facfe;
      background: rgba(79, 172, 254, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .dark .ec-range {
      color: #3b82f6;
      background: rgba(59, 130, 246, 0.15);
    }

    .ec-level-desc {
      font-size: 13px;
      line-height: 1.6;
      color: #34495e;
    }

    .dark .ec-level-desc {
      color: rgb(209, 213, 219);
    }

    .qr-placeholder svg {
      width: 64px;
      height: 64px;
      margin-bottom: 12px;
    }

    .scan-methods {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    @media (max-width: 768px) {
      .scan-methods {
        grid-template-columns: 1fr;
      }
    }

    .scan-method {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }

    .dark .scan-method {
      background: rgb(31, 41, 55);
    }

    .method-title {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 16px;
    }

    .dark .method-title {
      color: rgb(243, 244, 246);
    }

    .method-icon {
      width: 24px;
      height: 24px;
      color: #4facfe;
    }

    .dark .method-icon {
      color: #3b82f6;
    }

    .file-input {
      display: none;
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .file-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .file-label svg {
      width: 20px;
      height: 20px;
    }

    .scan-output {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    .webcam-video {
      display: none;
      max-width: 100%;
      width: 640px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .webcam-video.active {
      display: block;
    }

    .scan-canvas {
      display: none;
    }

    .scan-result {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 640px;
    }

    .dark .scan-result {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgb(34, 197, 94);
    }

    .scan-result.hidden {
      display: none;
    }

    .result-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      color: #155724;
    }

    .dark .result-header {
      color: rgb(134, 239, 172);
    }

    .result-header svg {
      width: 32px;
      height: 32px;
    }

    .result-header h3 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }

    .result-text {
      background: white;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      word-break: break-all;
      color: #2c3e50;
      margin-bottom: 16px;
    }

    .dark .result-text {
      background: rgb(17, 24, 39);
      color: rgb(229, 231, 235);
    }

    .result-actions {
      display: flex;
      justify-content: center;
    }

    /* Info section styles (shared with other tools) */
    .info-section {
      background: linear-gradient(135deg, #4facfe15 0%, #00f2fe15 100%);
      border-radius: 16px;
      padding: 48px;
      margin-top: 48px;
      border: 1px solid rgba(79, 172, 254, 0.1);
    }

    .dark .info-section {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
      border-color: rgba(59, 130, 246, 0.2);
    }

    .info-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 40px;
      padding-bottom: 24px;
      border-bottom: 2px solid rgba(79, 172, 254, 0.2);
    }

    .dark .info-header {
      border-bottom-color: rgba(59, 130, 246, 0.3);
    }

    .info-header-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 8px 16px rgba(79, 172, 254, 0.3);
    }

    .info-header-icon svg {
      width: 36px;
      height: 36px;
      color: white;
    }

    .info-title {
      font-size: 32px;
      font-weight: 700;
      color: #2c3e50;
      margin: 0;
      line-height: 1.2;
    }

    .dark .info-title {
      color: rgb(243, 244, 246);
    }

    .info-tagline {
      font-size: 16px;
      color: #4facfe;
      margin: 4px 0 0 0;
      font-weight: 500;
    }

    .dark .info-tagline {
      color: #3b82f6;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .info-card {
      background: white;
      border-radius: 12px;
      padding: 28px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      border: 1px solid #e1e8ed;
    }

    .dark .info-card {
      background: rgb(17, 24, 39);
      border-color: rgb(55, 65, 81);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .info-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(79, 172, 254, 0.15);
    }

    .dark .info-card:hover {
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }

    .highlight-card {
      background: linear-gradient(135deg, #4facfe10 0%, #00f2fe10 100%);
      border: 2px solid #4facfe;
    }

    .dark .highlight-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
      border-color: #3b82f6;
    }

    .card-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .card-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
      margin: 0 0 12px 0;
    }

    .dark .card-title {
      color: rgb(243, 244, 246);
    }

    .card-content {
      font-size: 15px;
      line-height: 1.7;
      color: #34495e;
      margin: 0;
    }

    .dark .card-content {
      color: rgb(209, 213, 219);
    }

    .card-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .card-list li {
      font-size: 14px;
      line-height: 1.7;
      color: #34495e;
      margin-bottom: 12px;
      padding-left: 28px;
      position: relative;
    }

    .dark .card-list li {
      color: rgb(209, 213, 219);
    }

    .card-list li::before {
      content: "✓";
      position: absolute;
      left: 0;
      color: #4facfe;
      font-weight: bold;
      font-size: 18px;
    }

    .info-note {
      display: flex;
      gap: 20px;
      background: linear-gradient(135deg, #fff3cd 0%, #ffe8a3 100%);
      border-left: 4px solid #ffc107;
      padding: 24px;
      border-radius: 12px;
      align-items: start;
    }

    .dark .info-note {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.1) 100%);
      border-left-color: rgb(251, 191, 36);
    }

    .note-icon {
      width: 40px;
      height: 40px;
      background: #ffc107;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .dark .note-icon {
      background: rgba(251, 191, 36, 0.2);
    }

    .note-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .dark .note-icon svg {
      color: rgb(251, 191, 36);
    }

    .note-title {
      font-size: 18px;
      font-weight: 700;
      color: #856404;
      margin: 0 0 8px 0;
    }

    .dark .note-title {
      color: rgb(251, 191, 36);
    }

    .note-content {
      font-size: 15px;
      line-height: 1.7;
      color: #856404;
      margin: 0;
    }

    .dark .note-content {
      color: rgb(253, 224, 71);
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 100px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      opacity: 0;
      transform: translateX(400px);
      transition: all 0.3s ease;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }

    .notification-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .dark .notification-success {
      background: rgba(34, 197, 94, 0.2);
      color: rgb(134, 239, 172);
      border-left-color: rgb(34, 197, 94);
    }

    .notification-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .dark .notification-error {
      background: rgba(239, 68, 68, 0.2);
      color: rgb(252, 165, 165);
      border-left-color: rgb(239, 68, 68);
    }

    .notification-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .dark .notification-warning {
      background: rgba(251, 191, 36, 0.2);
      color: rgb(253, 224, 71);
      border-left-color: rgb(251, 191, 36);
    }

    .notification-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .dark .notification-info {
      background: rgba(14, 165, 233, 0.2);
      color: rgb(125, 211, 252);
      border-left-color: rgb(14, 165, 233);
    }
  </style>
</Layout>

